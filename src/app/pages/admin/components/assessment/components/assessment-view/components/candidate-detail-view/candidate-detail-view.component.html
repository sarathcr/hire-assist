@if (isLoading) {
  <app-candidate-detail-view-skeleton />
} @else {
  <div class="candidate-detail">
    <!-- Header Section -->
    @if (candidateDetailsDataSource !== undefined) {
      @if (isCoverImageLoading) {
        <app-candidate-detail-header-skeleton />
      } @else {
        <div class="candidate-detail__header">
          <div class="candidate-detail__header-content">
            <div class="candidate-detail__avatar">
              <i class="pi pi-user"></i>
            </div>
            <div class="candidate-detail__header-info">
              <h1 class="candidate-detail__name">
                {{ candidateDetailsDataSource.name }}
              </h1>
              <p class="candidate-detail__email">
                <i class="pi pi-envelope"></i>
                {{ candidateDetailsDataSource.email }}
              </p>
            </div>
          </div>
        </div>
      }
    }

    <!-- Tabs Section -->
    <p-tabs value="0" class="candidate-detail__tabs">
      <p-tablist>
        <p-tab value="0">
          <i class="pi pi-user mr-2"></i>
          Candidate Details
        </p-tab>
        <p-tab value="1">
          <i class="pi pi-history mr-2"></i>
          Previous Assessments
        </p-tab>
      </p-tablist>

      <p-tabpanels>
        <!-- Candidate Details Tab -->
        <p-tabpanel value="0">
          <div class="candidate-detail__content">
            <!-- Basic Information Card -->
            <div class="candidate-detail__section">
              <h2 class="candidate-detail__section-title">
                <i class="pi pi-info-circle"></i>
                Basic Information
              </h2>
              <div class="candidate-detail__card">
                @if (candidateDetailsDataSource !== undefined) {
                  <div class="candidate-detail__info-grid">
                    <div class="candidate-detail__info-item">
                      <div class="candidate-detail__info-icon">
                        <i class="pi pi-calendar"></i>
                      </div>
                      <div class="candidate-detail__info-content">
                        <span class="candidate-detail__info-label">Date of Birth</span>
                        <span class="candidate-detail__info-value">
                          {{
                            candidateDetailsDataSource.dob
                              | date: "dd MMMM yyyy"
                          }}
                        </span>
                      </div>
                    </div>

                    <div class="candidate-detail__info-item">
                      <div class="candidate-detail__info-icon">
                        <i class="pi pi-user"></i>
                      </div>
                      <div class="candidate-detail__info-content">
                        <span class="candidate-detail__info-label">Gender</span>
                        <span class="candidate-detail__info-value">
                          {{ candidateDetailsDataSource.gender }}
                        </span>
                      </div>
                    </div>

                    <div class="candidate-detail__info-item">
                      <div class="candidate-detail__info-icon">
                        <i class="pi pi-phone"></i>
                      </div>
                      <div class="candidate-detail__info-content">
                        <span class="candidate-detail__info-label">Phone Number</span>
                        <span class="candidate-detail__info-value">
                          {{ candidateDetailsDataSource.phoneNumber }}
                        </span>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>

            <!-- Application Details Card -->
            <div class="candidate-detail__section">
              <h2 class="candidate-detail__section-title">
                <i class="pi pi-file-edit"></i>
                Application Details
              </h2>
              <div class="candidate-detail__card">
                @if (candidateDetailsDataSource !== undefined) {
                  @if (
                    (candidateDetailsDataSource.answers?.length ?? 0) > 0
                  ) {
                    <p-accordion [multiple]="true" class="candidate-detail__accordion">
                      @for (
                        answer of candidateDetailsDataSource.answers;
                        track answer.question
                      ) {
                        <p-accordion-panel [value]="answer.question">
                          <p-accordion-header>
                            <span class="candidate-detail__question">
                              {{ answer.question }}
                            </span>
                          </p-accordion-header>
                          <p-accordion-content>
                            <div class="candidate-detail__answer">
                              {{ answer.answer }}
                            </div>
                          </p-accordion-content>
                        </p-accordion-panel>
                      }
                    </p-accordion>
                  } @else {
                    <div class="candidate-detail__empty-state">
                      <i class="pi pi-inbox"></i>
                      <p>No application details available</p>
                    </div>
                  }
                }
              </div>
            </div>
          </div>
        </p-tabpanel>

        <!-- Previous Assessments Tab -->
        <p-tabpanel value="1">
          <div class="candidate-detail__content">
            @if (!isLoadingPreviousAssessments) {
              @if (candidateAssessmentDataSource !== undefined) {
                @if (candidateAssessmentDataSource.length > 0) {
                  <div class="candidate-detail__assessments">
                    @for (
                      assessment of candidateAssessmentDataSource;
                      track assessment.assessmentId
                    ) {
                      <div class="candidate-detail__assessment-card">
                        <div class="candidate-detail__assessment-header">
                          <h3 class="candidate-detail__assessment-title">
                            <i class="pi pi-briefcase"></i>
                            {{ assessment.assessmentName }}
                          </h3>
                        </div>

                        <p-accordion [multiple]="true" class="candidate-detail__rounds-accordion">
                          @for (
                            round of assessment.roundsDetails;
                            track round.roundId
                          ) {
                            <p-accordion-panel [value]="round.roundId">
                              <p-accordion-header>
                                <div class="candidate-detail__round-header">
                                  <span class="candidate-detail__round-name">
                                    <i class="pi pi-sitemap"></i>
                                    {{ round.roundName }}
                                  </span>
                                  <span class="candidate-detail__round-status">
                                    {{ round.status }}
                                  </span>
                                </div>
                              </p-accordion-header>
                              <p-accordion-content>
                                <!-- Aptitude Round Details -->
                                @if (round.roundId === 1) {
                                  @if (
                                    round.assessmentDetails &&
                                    round.assessmentDetails.length > 0
                                  ) {
                                    <div class="candidate-detail__round-details">
                                      <div class="candidate-detail__details-grid">
                                        <div class="candidate-detail__detail-item">
                                          <span class="candidate-detail__detail-label">Question Set</span>
                                          <span class="candidate-detail__detail-value">
                                            {{
                                              round.assessmentDetails[0]
                                                .questionSet
                                            }}
                                          </span>
                                        </div>
                                        <div class="candidate-detail__detail-item">
                                          <span class="candidate-detail__detail-label">Batch</span>
                                          <span class="candidate-detail__detail-value">
                                            {{ round.assessmentDetails[0].batch }}
                                          </span>
                                        </div>
                                        <div class="candidate-detail__detail-item">
                                          <span class="candidate-detail__detail-label">Total Questions</span>
                                          <span class="candidate-detail__detail-value">
                                            {{
                                              round.assessmentDetails[0]
                                                .totalQuestions
                                            }}
                                          </span>
                                        </div>
                                        <div class="candidate-detail__detail-item">
                                          <span class="candidate-detail__detail-label">Attended Questions</span>
                                          <span class="candidate-detail__detail-value">
                                            {{
                                              round.assessmentDetails[0]
                                                .attendedQuestions
                                            }}
                                          </span>
                                        </div>
                                        <div class="candidate-detail__detail-item">
                                          <span class="candidate-detail__detail-label">Correct Answers</span>
                                          <span class="candidate-detail__detail-value candidate-detail__detail-value--success">
                                            {{
                                              round.assessmentDetails[0]
                                                .correctAnswers
                                            }}
                                          </span>
                                        </div>
                                        <div class="candidate-detail__detail-item">
                                          <span class="candidate-detail__detail-label">Skipped</span>
                                          <span class="candidate-detail__detail-value">
                                            {{ round.assessmentDetails[0].skipped }}
                                          </span>
                                        </div>
                                      </div>
                                    </div>
                                  } @else {
                                    <div class="candidate-detail__empty-state">
                                      <i class="pi pi-info-circle"></i>
                                      <p>The details of the aptitude round are not available.</p>
                                    </div>
                                  }
                                } @else {
                                  <!-- Interview Round Details -->
                                  @if (round.assessmentDetails.length > 0) {
                                    <p-accordion [multiple]="true" class="candidate-detail__interviewers-accordion">
                                      @for (
                                        interviewer of round.assessmentDetails;
                                        track interviewer.interviewerId
                                      ) {
                                        <p-accordion-panel
                                          [value]="interviewer.interviewerId"
                                        >
                                          <p-accordion-header>
                                            <div class="candidate-detail__interviewer-header">
                                              <span class="candidate-detail__interviewer-name">
                                                <i class="pi pi-user"></i>
                                                {{ interviewer.interviewerName }}
                                              </span>
                                              <span class="candidate-detail__score-badge">
                                                Score: {{ interviewer.totalScore }}/{{ interviewer.outofScore }}
                                              </span>
                                            </div>
                                          </p-accordion-header>
                                          <p-accordion-content>
                                            @if (
                                              interviewer.feedbackListDto.length > 0
                                            ) {
                                              <p-accordion [multiple]="true" class="candidate-detail__feedback-accordion">
                                                @for (
                                                  feedback of interviewer.feedbackListDto;
                                                  track feedback.criteria
                                                ) {
                                                  <p-accordion-panel
                                                    [value]="feedback.criteria"
                                                  >
                                                    <p-accordion-header>
                                                      <div class="candidate-detail__feedback-header">
                                                        <span class="candidate-detail__feedback-criteria">
                                                          {{ feedback.criteria }}
                                                        </span>
                                                        @if (
                                                          feedback.feedbackScore !==
                                                            null &&
                                                          feedback.feedbackScore !==
                                                            undefined
                                                        ) {
                                                          <span class="candidate-detail__score-badge">
                                                            Score: {{ feedback.feedbackScore }}/{{ feedback.maxScore }}
                                                          </span>
                                                        }
                                                      </div>
                                                    </p-accordion-header>
                                                    <p-accordion-content>
                                                      <div class="candidate-detail__feedback-content">
                                                        <p-editor
                                                          [(ngModel)]="feedback.feedbackDetails"
                                                          [readonly]="editorStatus"
                                                          [style]="{ height: '200px' }"
                                                        />
                                                      </div>
                                                    </p-accordion-content>
                                                  </p-accordion-panel>
                                                }
                                              </p-accordion>
                                            } @else {
                                              <div class="candidate-detail__empty-state">
                                                <i class="pi pi-comment"></i>
                                                <p>No feedback available for this interviewer.</p>
                                              </div>
                                            }
                                          </p-accordion-content>
                                        </p-accordion-panel>
                                      }
                                    </p-accordion>
                                  } @else {
                                    <div class="candidate-detail__empty-state">
                                      <i class="pi pi-users"></i>
                                      <p>No interviewers available for this round.</p>
                                    </div>
                                  }
                                }
                              </p-accordion-content>
                            </p-accordion-panel>
                          }
                        </p-accordion>
                      </div>
                    }
                  </div>
                } @else {
                  <div class="candidate-detail__empty-state candidate-detail__empty-state--large">
                    <i class="pi pi-inbox"></i>
                    <p>No previous assessment data available</p>
                  </div>
                }
              }
            } @else {
              <app-candidate-detail-previous-assessment-skeleton />
            }
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </div>
}
