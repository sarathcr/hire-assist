@if (isLoading) {
  <app-candidate-detail-view-skeleton />
} @else {
  <div class="candidate-detail">
    <!-- Header Section -->
    @if (candidateDetailsDataSource !== undefined) {
      @if (isCoverImageLoading) {
        <app-candidate-detail-header-skeleton />
      } @else {
        <div class="candidate-detail__header">
          <div class="candidate-detail__header-content">
            <div class="candidate-detail__avatar">
              <i class="pi pi-user"></i>
            </div>
            <div class="candidate-detail__header-info">
              <h1 class="candidate-detail__name">
                {{ candidateDetailsDataSource.name }}
              </h1>
              <p class="candidate-detail__email">
                <i class="pi pi-envelope"></i>
                {{ candidateDetailsDataSource.email }}
              </p>
            </div>
          </div>
        </div>
      }
    }

    <!-- Tabs Section -->
    <p-tabs value="0" class="candidate-detail__tabs" (valueChange)="onTabChange($event)">
      <p-tablist>
        <p-tab value="0">
          <i class="pi pi-user mr-2"></i>
          Candidate Details
        </p-tab>
        <p-tab value="1">
          <i class="pi pi-history mr-2"></i>
          Previous Recruitments
        </p-tab>
        <p-tab value="2">
          <i class="pi pi-comments mr-2"></i>
          Interview Feedbacks
        </p-tab>
      </p-tablist>

      <p-tabpanels>
        <!-- Candidate Details Tab -->
        <p-tabpanel value="0">
          <div class="candidate-detail__content">
            <!-- Basic Information Card -->
            <div class="candidate-detail__section">
              <h2 class="candidate-detail__section-title">
                <i class="pi pi-info-circle"></i>
                Basic Information
              </h2>
              <div class="candidate-detail__card">
                @if (candidateDetailsDataSource !== undefined) {
                  <div class="candidate-detail__info-grid">
                    <div class="candidate-detail__info-item">
                      <div class="candidate-detail__info-icon">
                        <i class="pi pi-calendar"></i>
                      </div>
                      <div class="candidate-detail__info-content">
                        <span class="candidate-detail__info-label"
                          >Date of Birth</span
                        >
                        <span class="candidate-detail__info-value">
                          {{
                            candidateDetailsDataSource.dob
                              | date: "dd MMMM yyyy"
                          }}
                        </span>
                      </div>
                    </div>

                    <div class="candidate-detail__info-item">
                      <div class="candidate-detail__info-icon">
                        <i class="pi pi-user"></i>
                      </div>
                      <div class="candidate-detail__info-content">
                        <span class="candidate-detail__info-label">Gender</span>
                        <span class="candidate-detail__info-value">
                          {{ candidateDetailsDataSource.gender }}
                        </span>
                      </div>
                    </div>

                    <div class="candidate-detail__info-item">
                      <div class="candidate-detail__info-icon">
                        <i class="pi pi-phone"></i>
                      </div>
                      <div class="candidate-detail__info-content">
                        <span class="candidate-detail__info-label"
                          >Phone Number</span
                        >
                        <span class="candidate-detail__info-value">
                          {{ candidateDetailsDataSource.phoneNumber }}
                        </span>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>

            <!-- Application Details Card -->
            <div class="candidate-detail__section">
              <h2 class="candidate-detail__section-title">
                <i class="pi pi-file-edit"></i>
                Application Details
              </h2>
              <div class="candidate-detail__card">
                @if (candidateDetailsDataSource !== undefined) {
                  @if ((candidateDetailsDataSource.answers?.length ?? 0) > 0) {
                    <p-accordion
                      [multiple]="true"
                      class="candidate-detail__accordion"
                    >
                      @for (
                        answer of candidateDetailsDataSource.answers;
                        track answer.question
                      ) {
                        <p-accordion-panel [value]="answer.question">
                          <p-accordion-header>
                            <span class="candidate-detail__question">
                              {{ answer.question }}
                            </span>
                          </p-accordion-header>
                          <p-accordion-content>
                            <div class="candidate-detail__answer">
                              {{ answer.answer }}
                            </div>
                          </p-accordion-content>
                        </p-accordion-panel>
                      }
                    </p-accordion>
                  } @else {
                    <app-empty-state message="No application details available">
                    </app-empty-state>
                  }
                }
              </div>
            </div>
          </div>
        </p-tabpanel>

        <!-- Previous Assessments Tab -->
        <p-tabpanel value="1">
          <div class="candidate-detail__content">
            @if (!isLoadingPreviousAssessments) {
              @if (candidateAssessmentDataSource !== undefined) {
                @if (candidateAssessmentDataSource.length > 0) {
                  <div class="candidate-detail__assessments">
                    @for (
                      assessment of candidateAssessmentDataSource;
                      track assessment.assessmentId
                    ) {
                      <div class="candidate-detail__assessment-card">
                        <div class="candidate-detail__assessment-header">
                          <h3 class="candidate-detail__assessment-title">
                            <i class="pi pi-briefcase"></i>
                            {{ assessment.assessmentName }}
                          </h3>
                        </div>

                        <p-accordion
                          [multiple]="true"
                          class="candidate-detail__rounds-accordion"
                        >
                          @for (
                            round of assessment.roundsDetails;
                            track round.roundId
                          ) {
                            <p-accordion-panel [value]="round.roundId">
                              <p-accordion-header>
                                <div class="candidate-detail__round-header">
                                  <span class="candidate-detail__round-name">
                                    <i class="pi pi-sitemap"></i>
                                    {{ round.roundName }}
                                  </span>
                                  <span class="candidate-detail__round-status">
                                    {{ round.status }}
                                  </span>
                                </div>
                              </p-accordion-header>
                              <p-accordion-content>
                                <!-- Aptitude Round Details -->
                                @if (round.roundId === 1) {
                                  @if (
                                    round.assessmentDetails &&
                                    round.assessmentDetails.length > 0
                                  ) {
                                    <div
                                      class="candidate-detail__round-details"
                                    >
                                      <div
                                        class="candidate-detail__details-grid"
                                      >
                                        <div
                                          class="candidate-detail__detail-item"
                                        >
                                          <span
                                            class="candidate-detail__detail-label"
                                            >Question Set</span
                                          >
                                          <span
                                            class="candidate-detail__detail-value"
                                          >
                                            {{
                                              round.assessmentDetails[0]
                                                .questionSet
                                            }}
                                          </span>
                                        </div>
                                        <div
                                          class="candidate-detail__detail-item"
                                        >
                                          <span
                                            class="candidate-detail__detail-label"
                                            >Batch</span
                                          >
                                          <span
                                            class="candidate-detail__detail-value"
                                          >
                                            {{
                                              round.assessmentDetails[0].batch
                                            }}
                                          </span>
                                        </div>
                                        <div
                                          class="candidate-detail__detail-item"
                                        >
                                          <span
                                            class="candidate-detail__detail-label"
                                            >Total Questions</span
                                          >
                                          <span
                                            class="candidate-detail__detail-value"
                                          >
                                            {{
                                              round.assessmentDetails[0]
                                                .totalQuestions
                                            }}
                                          </span>
                                        </div>
                                        <div
                                          class="candidate-detail__detail-item"
                                        >
                                          <span
                                            class="candidate-detail__detail-label"
                                            >Attended Questions</span
                                          >
                                          <span
                                            class="candidate-detail__detail-value"
                                          >
                                            {{
                                              round.assessmentDetails[0]
                                                .attendedQuestions
                                            }}
                                          </span>
                                        </div>
                                        <div
                                          class="candidate-detail__detail-item"
                                        >
                                          <span
                                            class="candidate-detail__detail-label"
                                            >Correct Answers</span
                                          >
                                          <span
                                            class="candidate-detail__detail-value candidate-detail__detail-value--success"
                                          >
                                            {{
                                              round.assessmentDetails[0]
                                                .correctAnswers
                                            }}
                                          </span>
                                        </div>
                                        <div
                                          class="candidate-detail__detail-item"
                                        >
                                          <span
                                            class="candidate-detail__detail-label"
                                            >Skipped</span
                                          >
                                          <span
                                            class="candidate-detail__detail-value"
                                          >
                                            {{
                                              round.assessmentDetails[0].skipped
                                            }}
                                          </span>
                                        </div>
                                      </div>
                                    </div>
                                  } @else {
                                    <div class="candidate-detail__empty-state">
                                      <i class="pi pi-info-circle"></i>
                                      <p>
                                        The details of the aptitude round are
                                        not available.
                                      </p>
                                    </div>
                                  }
                                } @else {
                                  <!-- Interview Round Details -->
                                  @if (round.assessmentDetails.length > 0) {
                                    <p-accordion
                                      [multiple]="true"
                                      class="candidate-detail__interviewers-accordion"
                                    >
                                      @for (
                                        interviewer of round.assessmentDetails;
                                        track interviewer.interviewerId
                                      ) {
                                        <p-accordion-panel
                                          [value]="interviewer.interviewerId"
                                        >
                                          <p-accordion-header>
                                            <div
                                              class="candidate-detail__interviewer-header"
                                            >
                                              <span
                                                class="candidate-detail__interviewer-name"
                                              >
                                                <i class="pi pi-user"></i>
                                                {{
                                                  interviewer.interviewerName
                                                }}
                                              </span>
                                              <span
                                                class="candidate-detail__score-badge"
                                              >
                                                Score:
                                                {{ interviewer.totalScore }}/{{
                                                  interviewer.outofScore
                                                }}
                                              </span>
                                            </div>
                                          </p-accordion-header>
                                          <p-accordion-content>
                                            @if (
                                              interviewer.feedbackListDto
                                                .length > 0
                                            ) {
                                              <p-accordion
                                                [multiple]="true"
                                                class="candidate-detail__feedback-accordion"
                                              >
                                                @for (
                                                  feedback of interviewer.feedbackListDto;
                                                  track feedback.criteria
                                                ) {
                                                  <p-accordion-panel
                                                    [value]="feedback.criteria"
                                                  >
                                                    <p-accordion-header>
                                                      <div
                                                        class="candidate-detail__feedback-header"
                                                      >
                                                        <span
                                                          class="candidate-detail__feedback-criteria"
                                                        >
                                                          {{
                                                            feedback.criteria
                                                          }}
                                                        </span>
                                                        @if (
                                                          feedback.feedbackScore !==
                                                            null &&
                                                          feedback.feedbackScore !==
                                                            undefined
                                                        ) {
                                                          <span
                                                            class="candidate-detail__score-badge"
                                                          >
                                                            Score:
                                                            {{
                                                              feedback.feedbackScore
                                                            }}/{{
                                                              feedback.maxScore
                                                            }}
                                                          </span>
                                                        }
                                                      </div>
                                                    </p-accordion-header>
                                                    <p-accordion-content>
                                                      <div
                                                        class="candidate-detail__feedback-content"
                                                      >
                                                        <p-editor
                                                          [(ngModel)]="
                                                            feedback.feedbackDetails
                                                          "
                                                          [readonly]="
                                                            editorStatus
                                                          "
                                                          [style]="{
                                                            height: '200px',
                                                          }"
                                                        />
                                                      </div>
                                                    </p-accordion-content>
                                                  </p-accordion-panel>
                                                }
                                              </p-accordion>
                                            } @else {
                                              <app-empty-state
                                                icon="pi pi-comment"
                                                message="No feedback available for this
                                                  interviewer."
                                              >
                                              </app-empty-state>
                                            }
                                          </p-accordion-content>
                                        </p-accordion-panel>
                                      }
                                    </p-accordion>
                                  } @else {
                                    <app-empty-state
                                      icon="pi pi-users"
                                      message="No interviewers available for this
                                        round."
                                    >
                                    </app-empty-state>
                                  }
                                }
                              </p-accordion-content>
                            </p-accordion-panel>
                          }
                        </p-accordion>
                      </div>
                    }
                  </div>
                } @else {
                  <app-empty-state message="No previous recruitments found">
                  </app-empty-state>
                }
              }
            } @else {
              <app-candidate-detail-previous-assessment-skeleton />
            }
          </div>
        </p-tabpanel>

        <!-- Interview Feedbacks Tab -->
        <p-tabpanel value="2">
          <div class="candidate-detail__content">
            @if (isLoadingInterviewFeedbacks) {
              <app-candidate-detail-previous-assessment-skeleton />
            } @else {
              @if (interviewFeedbacksDataSource?.previousInterviews && interviewFeedbacksDataSource.previousInterviews.length > 0) {
                <div class="candidate-detail__assessments">
                  <p-accordion [multiple]="true" class="candidate-detail__rounds-accordion">
                    @for (round of interviewFeedbacksDataSource.previousInterviews; track round.roundId) {
                      <p-accordion-panel [value]="round.sequence">
                        <p-accordion-header>
                          <div class="candidate-detail__round-header">
                            <span class="candidate-detail__round-name">
                              <i class="pi pi-sitemap"></i>
                              {{ round.roundName }}
                            </span>
                            @if (round.status) {
                              <p-tag [value]="round.status" [severity]="getStatusSeverityFromString(round.status)" />
                            }
                          </div>
                        </p-accordion-header>
                        <p-accordion-content>
                          @if (round.assessmentDetails && round.assessmentDetails.length > 0) {
                            <div class="candidate-detail__round-details">
                              @for (detail of round.assessmentDetails; track $index) {
                                <div class="candidate-detail__details-grid" [style]="{'margin-bottom': '1rem', 'border-bottom': '1px solid #e5e7eb', 'padding-bottom': '1rem'}">
                                  <!-- Panel Name -->
                                  @if (hasValue(detail.panelName)) {
                                    <div class="candidate-detail__detail-item">
                                      <span class="candidate-detail__detail-label">Panel</span>
                                      <span class="candidate-detail__detail-value">{{ detail.panelName }}</span>
                                    </div>
                                  }
                                  
                                  <!-- Interviewer Name -->
                                  @if (hasValue(detail.interviewerName)) {
                                    <div class="candidate-detail__detail-item">
                                      <span class="candidate-detail__detail-label">Interviewer</span>
                                      <span class="candidate-detail__detail-value">{{ detail.interviewerName }}</span>
                                    </div>
                                  }

                                  <!-- Date -->
                                  @if (getDetailDate(detail)) {
                                    <div class="candidate-detail__detail-item">
                                      <span class="candidate-detail__detail-label">Date</span>
                                      <span class="candidate-detail__detail-value">{{ getDetailDate(detail) }}</span>
                                    </div>
                                  }

                                  <!-- Total Score -->
                                  @if (hasValue(detail.totalScore)) {
                                    <div class="candidate-detail__detail-item">
                                      <span class="candidate-detail__detail-label">Total Score</span>
                                      <span class="candidate-detail__detail-value">{{ detail.totalScore }}</span>
                                    </div>
                                  }
                                </div>

                                <!-- Feedback List -->
                                @if (detail.feedbackListDto && detail.feedbackListDto.length > 0) {
                                  <div class="candidate-detail__feedback-list">
                                    <h4 class="mb-2 font-semibold">Feedback Details</h4>
                                    @for (feedback of detail.feedbackListDto; track $index) {
                                      <div class="mb-3 p-3 border-round bg-gray-50">
                                        <div class="flex justify-content-between align-items-center mb-2">
                                          <span class="font-medium">{{ feedback.criteria }}</span>
                                          @if (feedback.feedbackScore !== null && feedback.feedbackScore !== undefined && feedback.criteria !== 'Attachments') {
                                            <p-tag [value]="feedback.feedbackScore + '/' + feedback.maxScore" severity="info" />
                                          }
                                        </div>
                                        
                                        @if (feedback.feedbackDetails) {
                                          <div class="text-sm" [innerHTML]="feedback.feedbackDetails"></div>
                                        }

                                        <!-- Attachments -->
                                        <!-- Attachments are not currently available in Feedback interface -->
                                      </div>
                                    }
                                  </div>
                                }
                              }
                            </div>
                          } @else {
                             <app-empty-state message="No details available for this round" />
                          }
                        </p-accordion-content>
                      </p-accordion-panel>
                    }
                  </p-accordion>
                </div>
              } @else {
                <app-empty-state message="No interview feedbacks found" />
              }
            }
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </div>
}
